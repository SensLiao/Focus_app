/**
 * å¼•å¯¼é¡µ - ç³»ç»Ÿä¸“æ³¨æ¨¡å¼æ•™å­¦ - ç²¾è‡´çŽ°ä»£é£Žæ ¼
 */

import router from '@ohos.router'
import common from '@ohos.app.ability.common'
import Want from '@ohos.app.ability.Want'
import { Theme } from '../common/theme'
import { Logger } from '../common/logger'
import promptAction from '@ohos.promptAction'

@Entry
@Component
struct GuidePage {
  @State showSettingsDialog: boolean = false
  @State headerOpacity: number = 0
  @State contentOpacity: number = 0

  aboutToAppear() {
    // å…¥åœºåŠ¨ç”»
    setTimeout(() => {
      this.headerOpacity = 1
    }, 100)
    setTimeout(() => {
      this.contentOpacity = 1
    }, 200)
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row({ space: 16 }) {
          Button({ type: ButtonType.Circle }) {
            Text('â†')
              .fontSize(Theme.FONT_SIZE_LARGE)
              .fontColor(Theme.COLOR_TEXT_SECONDARY)
          }
          .width(44)
          .height(44)
          .backgroundColor(Theme.COLOR_BACKGROUND)
          .onClick(() => {
            router.back()
          })

          Text('ä½¿ç”¨æŒ‡å—')
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
            .layoutWeight(1)

          Text('ðŸ“–')
            .fontSize(28)
        }
        .width('100%')
        .padding({ left: 16, right: 20, top: 12, bottom: 12 })
        .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
        .border({
          width: { bottom: 1 },
          color: Theme.COLOR_BORDER
        })
        .opacity(this.headerOpacity)
        .animation({
          duration: Theme.ANIMATION_NORMAL,
          curve: Curve.EaseOut
        })

        // å†…å®¹åŒº
        Scroll() {
          Column({ space: 20 }) {
            // æ ‡é¢˜åŒºåŸŸ
            Column({ space: 8 }) {
              Text('ðŸŽ¯')
                .fontSize(48)
              Text('å¦‚ä½•èŽ·å¾—æ›´å¥½çš„ä¸“æ³¨ä½“éªŒï¼Ÿ')
                .fontSize(Theme.FONT_SIZE_TITLE)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
                .textAlign(TextAlign.Center)
              Text('æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è®¾ç½®ï¼Œå¼€å¯é«˜æ•ˆä¸“æ³¨ä¹‹æ—…')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontColor(Theme.COLOR_TEXT_SECONDARY)
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding({ top: 16, bottom: 8 })

            // è¯´æ˜Žå¡ç‰‡1
            Column({ space: 14 }) {
              Row({ space: 10 }) {
                Column() {
                  Text('1')
                    .fontSize(Theme.FONT_SIZE_LARGE)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(36)
                .height(36)
                .borderRadius(18)
                .backgroundColor(Theme.COLOR_PRIMARY)
                .justifyContent(FlexAlign.Center)

                Text('å¼€å¯ç³»ç»Ÿä¸“æ³¨æ¨¡å¼')
                  .fontSize(Theme.FONT_SIZE_LARGE)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }

              Text('ä¸ºäº†æœ€å¤§åŒ–ä¸“æ³¨æ•ˆæžœï¼Œå»ºè®®æ‚¨æ‰‹åŠ¨å¼€å¯ç³»ç»Ÿçº§ä¸“æ³¨æ¨¡å¼ã€‚è¿™å°†ï¼š')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontColor(Theme.COLOR_TEXT_SECONDARY)

              Column({ space: 10 }) {
                Row({ space: 10 }) {
                  Text('ðŸ”•')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('å±è”½æ¥ç”µå’Œé€šçŸ¥å¹²æ‰°')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ“µ')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('å‡å°‘å…¶ä»–åº”ç”¨çš„æ‰“æ–­')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ§˜')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('è¥é€ ä¸“æ³¨æ°›å›´')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .padding({ left: 8 })

              Button('å‰å¾€ç³»ç»Ÿè®¾ç½®')
                .width('100%')
                .height(52)
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
                .backgroundColor(Theme.COLOR_PRIMARY)
                .borderRadius(Theme.BORDER_RADIUS_LARGE)
                .shadow(Theme.SHADOW_GLOW)
                .margin({ top: 4 })
                .onClick(() => {
                  this.showSettingsDialog = true
                })
            }
            .width('100%')
            .padding(22)
            .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
            .borderRadius(Theme.BORDER_RADIUS_LARGE)
            .shadow(Theme.SHADOW_MEDIUM)

            // è¯´æ˜Žå¡ç‰‡2
            Column({ space: 14 }) {
              Row({ space: 10 }) {
                Column() {
                  Text('2')
                    .fontSize(Theme.FONT_SIZE_LARGE)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(36)
                .height(36)
                .borderRadius(18)
                .backgroundColor(Theme.COLOR_SUCCESS)
                .justifyContent(FlexAlign.Center)

                Text('æœ¬åº”ç”¨çš„ä¸“æ³¨æœºåˆ¶')
                  .fontSize(Theme.FONT_SIZE_LARGE)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }

              Text('æœ¬åº”ç”¨é‡‡ç”¨"è½¯ä¸“æ³¨"ç­–ç•¥ï¼š')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontColor(Theme.COLOR_TEXT_SECONDARY)

              Column({ space: 10 }) {
                Row({ space: 10 }) {
                  Text('â±ï¸')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('åœ¨åº”ç”¨å†…å¼€å§‹ä¸“æ³¨è®¡æ—¶')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('â¸ï¸')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨æ—¶è‡ªåŠ¨æš‚åœ')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ””')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('5åˆ†é’ŸåŽæé†’æ‚¨ç»§ç»­ä¸“æ³¨')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ“Š')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('è®°å½•æ¯æ¬¡ä¸“æ³¨å’Œæ‰“æ–­')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .padding({ left: 8 })
            }
            .width('100%')
            .padding(22)
            .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
            .borderRadius(Theme.BORDER_RADIUS_LARGE)
            .shadow(Theme.SHADOW_MEDIUM)

            // ä½¿ç”¨å»ºè®®å¡ç‰‡
            Column({ space: 14 }) {
              Row({ space: 10 }) {
                Column() {
                  Text('3')
                    .fontSize(Theme.FONT_SIZE_LARGE)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(36)
                .height(36)
                .borderRadius(18)
                .backgroundColor('#F59E0B')
                .justifyContent(FlexAlign.Center)

                Text('ä½¿ç”¨å»ºè®®')
                  .fontSize(Theme.FONT_SIZE_LARGE)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }

              Column({ space: 10 }) {
                Row({ space: 10 }) {
                  Text('ðŸ…')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('æ¯æ¬¡ä¸“æ³¨ 25 åˆ†é’Ÿï¼Œä¼‘æ¯ 5 åˆ†é’Ÿ')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ“±')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('ä¸“æ³¨æ—¶ä¿æŒåœ¨åº”ç”¨å†…')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ“ˆ')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('å®ŒæˆåŽæŸ¥çœ‹åŽ†å²è®°å½•å’Œç»Ÿè®¡')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
                Row({ space: 10 }) {
                  Text('ðŸ’ª')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                  Text('åšæŒä½¿ç”¨ï¼Œå…»æˆä¸“æ³¨ä¹ æƒ¯')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .padding({ left: 8 })
            }
            .width('100%')
            .padding(22)
            .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
            .borderRadius(Theme.BORDER_RADIUS_LARGE)
            .shadow(Theme.SHADOW_MEDIUM)
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 40 })
          .opacity(this.contentOpacity)
          .animation({
            duration: Theme.ANIMATION_NORMAL,
            curve: Curve.EaseOut
          })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(Theme.COLOR_BACKGROUND)

      // è·³è½¬ç¡®è®¤å¯¹è¯æ¡†
      if (this.showSettingsDialog) {
        this.SettingsConfirmDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  SettingsConfirmDialog() {
    Column() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(Theme.COLOR_OVERLAY)
        .onClick(() => {
          this.showSettingsDialog = false
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    Column({ space: 20 }) {
      // å›¾æ ‡
      Column() {
        Text('âš™ï¸')
          .fontSize(40)
      }
      .width(72)
      .height(72)
      .borderRadius(36)
      .backgroundColor(Theme.COLOR_PRIMARY_BG)
      .justifyContent(FlexAlign.Center)

      Text('è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®')
        .fontSize(Theme.FONT_SIZE_TITLE)
        .fontWeight(FontWeight.Bold)
        .fontColor(Theme.COLOR_TEXT_PRIMARY)

      Text('å³å°†æ‰“å¼€æœ¬åº”ç”¨çš„ç³»ç»Ÿè®¾ç½®é¡µé¢ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡Œï¼š')
        .fontSize(Theme.FONT_SIZE_MEDIUM)
        .fontColor(Theme.COLOR_TEXT_SECONDARY)
        .textAlign(TextAlign.Center)

      Column({ space: 10 }) {
        Row({ space: 8 }) {
          Text('ðŸ””')
            .fontSize(Theme.FONT_SIZE_SMALL)
          Text('ç®¡ç†åº”ç”¨é€šçŸ¥æƒé™')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
        }
        Row({ space: 8 }) {
          Text('ðŸ’¾')
            .fontSize(Theme.FONT_SIZE_SMALL)
          Text('æŸ¥çœ‹åº”ç”¨å­˜å‚¨å’Œç¼“å­˜')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
        }
        Row({ space: 8 }) {
          Text('ðŸ”')
            .fontSize(Theme.FONT_SIZE_SMALL)
          Text('é…ç½®åº”ç”¨æƒé™è®¾ç½®')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .padding({ left: 16 })

      Row({ space: 14 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .height(52)
          .fontSize(Theme.FONT_SIZE_MEDIUM)
          .backgroundColor(Theme.COLOR_BACKGROUND)
          .fontColor(Theme.COLOR_TEXT_SECONDARY)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .border({ width: 1, color: Theme.COLOR_BORDER })
          .onClick(() => {
            this.showSettingsDialog = false
          })

        Button('å‰å¾€è®¾ç½®')
          .layoutWeight(1)
          .height(52)
          .fontSize(Theme.FONT_SIZE_MEDIUM)
          .fontWeight(FontWeight.Bold)
          .backgroundColor(Theme.COLOR_PRIMARY)
          .fontColor(Color.White)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_GLOW)
          .onClick(() => {
            this.showSettingsDialog = false
            this.openAppSettings()
          })
      }
      .width('100%')
    }
    .width('88%')
    .padding(28)
    .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
    .borderRadius(Theme.BORDER_RADIUS_XLARGE)
    .shadow(Theme.SHADOW_LARGE)
    .position({ x: '6%', y: '25%' })
  }

  private openAppSettings() {
    try {
      const context = getContext(this) as common.UIAbilityContext
      const bundleName = context.abilityInfo.bundleName

      // è·³è½¬åˆ°æœ¬åº”ç”¨çš„ç³»ç»Ÿè®¾ç½®é¡µé¢
      const want: Want = {
        action: 'action.settings.app.info',
        uri: 'application_info_entry',
        parameters: {
          pushParams: bundleName
        }
      }

      context.startAbility(want).then(() => {
        Logger.info('æˆåŠŸè·³è½¬åˆ°åº”ç”¨è®¾ç½®é¡µé¢')
      }).catch((err: Error) => {
        Logger.error('è·³è½¬å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹å¼', JSON.stringify(err))
        // å¤‡ç”¨æ–¹å¼ï¼šå°è¯•ç›´æŽ¥æ‰“å¼€ç³»ç»Ÿè®¾ç½®
        this.openSystemSettingsFallback(context)
      })
    } catch (error) {
      Logger.error('æ‰“å¼€ç³»ç»Ÿè®¾ç½®å¤±è´¥', JSON.stringify(error))
      promptAction.showToast({ message: 'æ— æ³•æ‰“å¼€ç³»ç»Ÿè®¾ç½®ï¼Œè¯·æ‰‹åŠ¨å‰å¾€' })
    }
  }

  private openSystemSettingsFallback(context: common.UIAbilityContext) {
    try {
      // å¤‡ç”¨æ–¹å¼ï¼šæ‰“å¼€ç³»ç»Ÿè®¾ç½®ä¸»é¡µ
      const want: Want = {
        bundleName: 'com.huawei.hmos.settings',
        abilityName: 'com.huawei.hmos.settings.MainAbility'
      }
      context.startAbility(want).then(() => {
        Logger.info('æˆåŠŸæ‰“å¼€ç³»ç»Ÿè®¾ç½®ä¸»é¡µ')
        promptAction.showToast({ message: 'è¯·åœ¨è®¾ç½®ä¸­æ‰¾åˆ°æœ¬åº”ç”¨è¿›è¡Œé…ç½®' })
      }).catch((err: Error) => {
        Logger.error('å¤‡ç”¨æ–¹å¼ä¹Ÿå¤±è´¥', JSON.stringify(err))
        promptAction.showToast({ message: 'æ— æ³•æ‰“å¼€ç³»ç»Ÿè®¾ç½®ï¼Œè¯·æ‰‹åŠ¨å‰å¾€è®¾ç½® > åº”ç”¨' })
      })
    } catch (error) {
      Logger.error('å¤‡ç”¨æ–¹å¼å¼‚å¸¸', JSON.stringify(error))
      promptAction.showToast({ message: 'è¯·æ‰‹åŠ¨å‰å¾€ è®¾ç½® > åº”ç”¨ > ä¸“æ³¨' })
    }
  }
}
