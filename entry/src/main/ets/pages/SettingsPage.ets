/**
 * è®¾ç½®é¡µé¢ - ç²¾è‡´ç°ä»£é£æ ¼
 */
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { BottomNav } from '../components/BottomNav'
import { Theme } from '../common/theme'
import { SettingsService } from '../services/SettingsService'

@Component
struct NumberSelector {
  @Link value: number
  @Prop min: number = 0
  @Prop max: number = 0
  @Prop step: number = 1
  @Prop unit: string = ''
  onChange?: (val: number) => void

  private updateValue(next: number) {
    this.value = next
    if (this.onChange) {
      this.onChange(next)
    }
  }

  build() {
    Row({ space: 8 }) {
      // å‡å°‘æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text('-')
          .fontSize(Theme.FONT_SIZE_LARGE)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.value <= this.min ? Theme.COLOR_TEXT_TERTIARY : Theme.COLOR_PRIMARY)
      }
      .width(42)
      .height(42)
      .backgroundColor(this.value <= this.min ? Theme.COLOR_BACKGROUND : Theme.COLOR_PRIMARY_BG)
      .enabled(this.value > this.min)
      .onClick(() => {
        if (this.value > this.min) {
          this.updateValue(this.value - this.step)
        }
      })

      // æ•°å€¼æ˜¾ç¤º
      Column() {
        Text(`${this.value}`)
          .fontSize(Theme.FONT_SIZE_TITLE)
          .fontWeight(FontWeight.Bold)
          .fontColor(Theme.COLOR_PRIMARY)
      }
      .width(56)
      .justifyContent(FlexAlign.Center)

      // å¢åŠ æŒ‰é’®
      Button({ type: ButtonType.Circle }) {
        Text('+')
          .fontSize(Theme.FONT_SIZE_LARGE)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.value >= this.max ? Theme.COLOR_TEXT_TERTIARY : Theme.COLOR_PRIMARY)
      }
      .width(42)
      .height(42)
      .backgroundColor(this.value >= this.max ? Theme.COLOR_BACKGROUND : Theme.COLOR_PRIMARY_BG)
      .enabled(this.value < this.max)
      .onClick(() => {
        if (this.value < this.max) {
          this.updateValue(this.value + this.step)
        }
      })
    }
  }
}

@Entry
@Component
struct SettingsPage {
  @State notifyOn: boolean = true
  @State allowRest: boolean = true
  @State restMinutes: number = 5
  @State restIntervalHours: number = 0
  @State restIntervalMinutes: number = 25
  @State focusDuration: number = 25
  @State initialRestMinutes: number = 5
  @State initialRestIntervalHours: number = 0
  @State initialRestIntervalMinutes: number = 25
  @State togglesReady: boolean = false
  @State headerOpacity: number = 0
  @State contentOpacity: number = 0

  async aboutToAppear() {
    // åˆå§‹åŒ–è®¾ç½®æœåŠ¡å¹¶åŠ è½½è®¾ç½®
    await SettingsService.init(getContext(this))
    const settings = SettingsService.getSettings()
    this.notifyOn = settings.notificationsEnabled
    this.allowRest = settings.restEnabled
    this.restMinutes = settings.defaultRestDuration
    this.focusDuration = settings.defaultFocusDuration
    // å°†ä¼‘æ¯é—´éš”åˆ†è§£ä¸ºå°æ—¶å’Œåˆ†é’Ÿ
    const totalMinutes = settings.defaultRestInterval
    this.restIntervalHours = Math.floor(totalMinutes / 60)
    this.restIntervalMinutes = totalMinutes % 60
    this.initialRestMinutes = this.restMinutes
    this.initialRestIntervalHours = this.restIntervalHours
    this.initialRestIntervalMinutes = this.restIntervalMinutes
    this.togglesReady = true

    // å…¥åœºåŠ¨ç”»
    setTimeout(() => {
      this.headerOpacity = 1
    }, 100)
    setTimeout(() => {
      this.contentOpacity = 1
    }, 200)
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜ - ç²¾è‡´æ ·å¼
      Row() {
        Column({ space: 2 }) {
          Text('âš™ï¸')
            .fontSize(28)
          Text('è®¾ç½®')
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .alignItems(VerticalAlign.Center)
      .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
      .border({
        width: { bottom: 1 },
        color: Theme.COLOR_BORDER
      })
      .opacity(this.headerOpacity)
      .animation({
        duration: Theme.ANIMATION_NORMAL,
        curve: Curve.EaseOut
      })

      // å¯æ»šåŠ¨å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // å¡ç‰‡1ï¼šé€šçŸ¥è®¾ç½®
          Column({ space: 16 }) {
            Row({ space: 8 }) {
              Text('ğŸ””')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('é€šçŸ¥è®¾ç½®')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('é€šçŸ¥æé†’')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åœ¨ä¸“æ³¨ç»“æŸæ—¶å‘é€æé†’')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.notifyOn })
                .selectedColor(Theme.COLOR_PRIMARY)
                .width(52)
                .height(30)
                .onChange(async (val: boolean) => {
                  if (!this.togglesReady) {
                    this.notifyOn = val
                    return
                  }
                  if (!val) {
                    AlertDialog.show({
                      title: 'å…³é—­é€šçŸ¥ï¼Ÿ',
                      message: 'é€šçŸ¥ç”¨äºæé†’ä½ è¿”å›ä¸“æ³¨ï¼Œæ˜¯åº”ç”¨å¿…è¦åŠŸèƒ½ã€‚',
                      primaryButton: {
                        value: 'å–æ¶ˆ',
                        action: () => {
                          this.notifyOn = true
                        }
                      },
                      secondaryButton: {
                        value: 'å…³é—­',
                        fontColor: Theme.COLOR_ERROR,
                        action: async () => {
                          this.notifyOn = false
                          await SettingsService.setNotificationsEnabled(false)
                        }
                      }
                    })
                    return
                  }
                  this.notifyOn = true
                  await SettingsService.setNotificationsEnabled(true)
                  promptAction.showToast({ message: 'å·²å¼€å¯é€šçŸ¥' })
                })
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('å…è®¸ä¼‘æ¯')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åœ¨ä¸“æ³¨è¿‡ç¨‹ä¸­å®‰æ’ä¼‘æ¯æ—¶é—´')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.allowRest })
                .selectedColor(Theme.COLOR_PRIMARY)
                .width(52)
                .height(30)
                .onChange(async (val: boolean) => {
                  if (!this.togglesReady) {
                    this.allowRest = val
                    return
                  }
                  if (!val) {
                    AlertDialog.show({
                      title: 'å…³é—­ä¼‘æ¯ï¼Ÿ',
                      message: 'å…³é—­ä¼‘æ¯åï¼Œä¸“æ³¨è¿‡ç¨‹ä¸­ä¸ä¼šå®‰æ’ä¼‘æ¯ï¼Œä½†ä½ ä»å¯ç»§ç»­ä¸“æ³¨ã€‚',
                      primaryButton: {
                        value: 'å–æ¶ˆ',
                        action: () => {
                          this.allowRest = true
                        }
                      },
                      secondaryButton: {
                        value: 'å…³é—­',
                        fontColor: Theme.COLOR_ERROR,
                        action: async () => {
                          this.allowRest = false
                          await SettingsService.setRestEnabled(false)
                        }
                      }
                    })
                    return
                  }
                  this.allowRest = true
                  await SettingsService.setRestEnabled(true)
                })
            }
            .width('100%')
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)

          // å¡ç‰‡2ï¼šä¸“æ³¨è®¾ç½®
          Column({ space: 18 }) {
            Row({ space: 8 }) {
              Text('ğŸ¯')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('ä¸“æ³¨è®¾ç½®')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            // é»˜è®¤ä¸“æ³¨æ—¶é•¿
            Row() {
              Column({ space: 4 }) {
                Text('é»˜è®¤ä¸“æ³¨æ—¶é•¿')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åˆ†é’Ÿ')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              NumberSelector({
                value: this.$focusDuration,
                min: 5,
                max: 120,
                step: 5,
                unit: 'min',
                onChange: async (val: number) => {
                  await SettingsService.setDefaultFocusDuration(val)
                }
              })
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            // é»˜è®¤ä¼‘æ¯æ—¶é•¿
            Row() {
              Column({ space: 4 }) {
                Text('é»˜è®¤ä¼‘æ¯æ—¶é•¿')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åˆ†é’Ÿ')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              NumberSelector({
                value: this.$restMinutes,
                min: 1,
                max: 30,
                step: 1,
                unit: 'min',
              })
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            // ä¼‘æ¯æé†’é—´éš”
            Column({ space: 12 }) {
              Column({ space: 4 }) {
                Text('ä¼‘æ¯æé†’é—´éš”')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('æ¯éš”æ­¤æ—¶é—´æé†’ä½ ä¼‘æ¯ä¸€ä¸‹')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .width('100%')

              Row({ space: 16 }) {
                // å°æ—¶é€‰æ‹©
                Row({ space: 6 }) {
                  NumberSelector({
                    value: this.$restIntervalHours,
                    min: 0,
                    max: 4,
                    step: 1,
                    unit: 'h',
                  })
                  Text('æ—¶')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_SECONDARY)
                }

                Text(':')
                  .fontSize(Theme.FONT_SIZE_LARGE)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
                  
                // åˆ†é’Ÿé€‰æ‹©
                Row({ space: 6 }) {
                  NumberSelector({
                    value: this.$restIntervalMinutes,
                    min: 0,
                    max: 55,
                    step: 5,
                    unit: 'min',
                  })
                  Text('åˆ†')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_SECONDARY)
                }
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)

              if (this.hasRestSettingsChanges()) {
                Button('ä¿å­˜æ›´æ”¹')
                  .width('100%')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .height(48)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Color.White)
                  .backgroundColor(Theme.COLOR_PRIMARY)
                  .borderRadius(Theme.BORDER_RADIUS_LARGE)
                  .shadow(Theme.SHADOW_GLOW)
                  .margin({ top: 8 })
                  .onClick(async () => {
                    await this.saveRestSettings()
                  })
              }
            }
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)

          // å¡ç‰‡3ï¼šå…³äº
          Column({ space: 16 }) {
            Row({ space: 8 }) {
              Text('â„¹ï¸')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('å…³äº')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('ç‰ˆæœ¬å·')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }
              .alignItems(HorizontalAlign.Start)
              
              Blank()
              
              Text('1.0.0')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_PRIMARY)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(Theme.COLOR_PRIMARY_BG)
                .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Row({ space: 8 }) {
                Text('ğŸ“–')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                Text('ä½¿ç”¨æŒ‡å—')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_PRIMARY)
              }
              Blank()
              Text('â€º')
                .fontSize(Theme.FONT_SIZE_TITLE)
                .fontColor(Theme.COLOR_TEXT_TERTIARY)
            }
            .width('100%')
            .padding({ top: 4, bottom: 4 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/GuidePage' })
            })
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)
        }
        .padding({ left: 20, right: 20, top: 20, bottom: 100 })
        .opacity(this.contentOpacity)
        .animation({
          duration: Theme.ANIMATION_NORMAL,
          curve: Curve.EaseOut
        })
      }
      .layoutWeight(1)

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNav({ currentIndex: 2 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Theme.COLOR_BACKGROUND)
  }

  // ä¿å­˜ä¼‘æ¯é—´éš”è®¾ç½®
  private hasRestSettingsChanges(): boolean {
    return this.restMinutes !== this.initialRestMinutes
      || this.restIntervalHours !== this.initialRestIntervalHours
      || this.restIntervalMinutes !== this.initialRestIntervalMinutes
  }

  private async saveRestSettings() {
    const totalMinutes = this.restIntervalHours * 60 + this.restIntervalMinutes
    await SettingsService.setDefaultRestDuration(this.restMinutes)
    await SettingsService.setDefaultRestInterval(totalMinutes)
    this.initialRestMinutes = this.restMinutes
    this.initialRestIntervalHours = this.restIntervalHours
    this.initialRestIntervalMinutes = this.restIntervalMinutes
    promptAction.showToast({ message: 'è®¾ç½®å·²ä¿å­˜' })
  }
}
