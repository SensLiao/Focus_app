/**
 * è®¾ç½®é¡µé¢ - ç²¾è‡´ç°ä»£é£æ ¼
 */
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { BottomNav } from '../components/BottomNav'
import { NumberSelector } from '../components/NumberSelector'
import { Theme } from '../common/theme'
import { SettingsService } from '../services/SettingsService'
import { shouldShowOnboarding } from '../onboarding/OnboardingFlow'

@Entry
@Component
struct SettingsPage {
  @State notifyOn: boolean = true
  @State allowRest: boolean = true
  @State restMinutes: number = 5
  @State restIntervalHours: number = 0
  @State restIntervalMinutes: number = 25
  @State focusDuration: number = 25
  @State initialRestMinutes: number = 5
  @State initialRestIntervalHours: number = 0
  @State initialRestIntervalMinutes: number = 25
  @State togglesReady: boolean = false
  @State headerOpacity: number = 0
  @State contentOpacity: number = 0
  // æ»‘åŠ¨æ‰‹åŠ¿ç›¸å…³
  @State panOffsetX: number = 0
  private readonly swipeThreshold: number = 80
  @StorageLink('hasSeenOnboarding') hasSeenOnboarding: boolean = false
  @StorageLink('onboardingDisabled') onboardingDisabled: boolean = false
  @StorageLink('onboardingStepId') onboardingStepId: string = ''

  async aboutToAppear() {
    // åˆå§‹åŒ–è®¾ç½®æœåŠ¡å¹¶åŠ è½½è®¾ç½®
    await SettingsService.init(getContext(this))
    const settings = SettingsService.getSettings()
    this.notifyOn = settings.notificationsEnabled
    this.allowRest = settings.restEnabled
    this.restMinutes = settings.defaultRestDuration
    this.focusDuration = settings.defaultFocusDuration
    // å°†ä¼‘æ¯é—´éš”åˆ†è§£ä¸ºå°æ—¶å’Œåˆ†é’Ÿ
    const totalMinutes = settings.defaultRestInterval
    this.restIntervalHours = Math.floor(totalMinutes / 60)
    this.restIntervalMinutes = totalMinutes % 60
    this.initialRestMinutes = this.restMinutes
    this.initialRestIntervalHours = this.restIntervalHours
    this.initialRestIntervalMinutes = this.restIntervalMinutes
    this.togglesReady = true

    // å…¥åœºåŠ¨ç”»
    setTimeout(() => {
      this.headerOpacity = 1
    }, 100)
    setTimeout(() => {
      this.contentOpacity = 1
    }, 200)
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜ - ç²¾è‡´æ ·å¼
      Row() {
        Row({ space: 10 }) {
          Text('âš™ï¸')
            .fontSize(Theme.FONT_SIZE_LARGE)
          Text('è®¾ç½®')
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)
        }
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .alignItems(VerticalAlign.Center)
      .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
      .border({
        width: { bottom: 1 },
        color: Theme.COLOR_BORDER
      })
      .opacity(this.headerOpacity)
      .animation({
        duration: Theme.ANIMATION_NORMAL,
        curve: Curve.EaseOut
      })

      // å¯æ»šåŠ¨å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // å¡ç‰‡1ï¼šé€šçŸ¥è®¾ç½®
          Column({ space: 16 }) {
            Row({ space: 8 }) {
              Text('ğŸ””')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('é€šçŸ¥è®¾ç½®')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('é€šçŸ¥æé†’')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åœ¨ä¸“æ³¨ç»“æŸæ—¶å‘é€æé†’')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.notifyOn })
                .selectedColor(Theme.COLOR_TEXT_PRIMARY)
                .width(52)
                .height(30)
                .onChange(async (val: boolean) => {
                  if (!this.togglesReady) {
                    this.notifyOn = val
                    return
                  }
                  if (!val) {
                    // å…ˆè®©çŠ¶æ€æ”¹å˜ï¼Œæ˜¾ç¤ºå…³é—­åŠ¨ç”»
                    this.notifyOn = false
                    AlertDialog.show({
                      title: 'å…³é—­é€šçŸ¥ï¼Ÿ',
                      message: 'é€šçŸ¥ç”¨äºæé†’ä½ è¿”å›ä¸“æ³¨ï¼Œæ˜¯åº”ç”¨å¿…è¦åŠŸèƒ½ã€‚',
                      primaryButton: {
                        value: 'å–æ¶ˆ',
                        action: () => {
                          // æ¢å¤åˆ°å¼€å¯çŠ¶æ€
                          this.notifyOn = true
                        }
                      },
                      secondaryButton: {
                        value: 'å…³é—­',
                        fontColor: Theme.COLOR_ERROR,
                        action: async () => {
                          this.notifyOn = false
                          await SettingsService.setNotificationsEnabled(false)
                        }
                      }
                    })
                    return
                  }
                  this.notifyOn = true
                  await SettingsService.setNotificationsEnabled(true)
                  promptAction.showToast({ message: 'å·²å¼€å¯é€šçŸ¥' })
                })
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('å…è®¸ä¼‘æ¯')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
                Text('åœ¨ä¸“æ³¨è¿‡ç¨‹ä¸­å®‰æ’ä¼‘æ¯æ—¶é—´')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.allowRest })
                .selectedColor(Theme.COLOR_TEXT_PRIMARY)
                .width(52)
                .height(30)
                .onChange(async (val: boolean) => {
                  if (!this.togglesReady) {
                    this.allowRest = val
                    return
                  }
                  if (!val) {
                    this.allowRest = true
                    AlertDialog.show({
                      title: 'å…³é—­ä¼‘æ¯ï¼Ÿ',
                      message: 'å…³é—­ä¼‘æ¯åï¼Œä¸“æ³¨è¿‡ç¨‹ä¸­ä¸ä¼šå®‰æ’ä¼‘æ¯ï¼Œä½†ä½ ä»å¯ç»§ç»­ä¸“æ³¨ã€‚',
                      primaryButton: {
                        value: 'å–æ¶ˆ',
                        action: () => {
                          this.allowRest = true
                        }
                      },
                      secondaryButton: {
                        value: 'å…³é—­',
                        fontColor: Theme.COLOR_ERROR,
                        action: async () => {
                          this.allowRest = false
                          await SettingsService.setRestEnabled(false)
                        }
                      }
                    })
                    return
                  }
                  this.allowRest = true
                  await SettingsService.setRestEnabled(true)
                })
            }
            .width('100%')
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)

          // å¡ç‰‡2ï¼šä¼‘æ¯è®¾ç½®
          Column({ space: 18 }) {
            Row({ space: 8 }) {
              Text('ğŸ¯')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('ä¼‘æ¯è®¾ç½®')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            if (this.allowRest) {
              // é»˜è®¤ä¼‘æ¯æ—¶é•¿
              Row() {
                Column({ space: 4 }) {
                  Text('é»˜è®¤ä¼‘æ¯æ—¶é•¿')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                  Text('åˆ†é’Ÿ')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_TERTIARY)
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                NumberSelector({
                  value: this.restMinutes,
                  min: 1,
                  max: 30,
                  step: 1,
                  unit: 'min',
                  onChange: (val: number) => {
                    this.restMinutes = val
                  }
                })
              }
              .width('100%')

              Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

              // ä¼‘æ¯æé†’é—´éš”
              Column({ space: 12 }) {
                Column({ space: 4 }) {
                  Text('ä¼‘æ¯æé†’é—´éš”')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                  Text('æ¯éš”æ­¤æ—¶é—´æé†’ä½ ä¼‘æ¯ä¸€ä¸‹')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_TERTIARY)
                }
                .alignItems(HorizontalAlign.Start)
                .width('100%')

                Row({ space: 6 }) {
                  // å°æ—¶é€‰æ‹©
                  NumberSelector({
                    value: this.restIntervalHours,
                    min: 0,
                    max: 4,
                    step: 1,
                    unit: 'h',
                    compact: true,
                    onChange: (val: number) => {
                      this.restIntervalHours = val
                    }
                  })

                  Text('æ—¶')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_SECONDARY)
                    .margin({ left: 2, right: 2 })

                  Text(':')
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Theme.COLOR_TEXT_TERTIARY)
                    .margin({ left: 2, right: 2 })
                    
                  // åˆ†é’Ÿé€‰æ‹©
                  NumberSelector({
                    value: this.restIntervalMinutes,
                    min: 0,
                    max: 55,
                    step: 5,
                    unit: 'min',
                    compact: true,
                    onChange: (val: number) => {
                      this.restIntervalMinutes = val
                    }
                  })

                  Text('åˆ†')
                    .fontSize(Theme.FONT_SIZE_SMALL)
                    .fontColor(Theme.COLOR_TEXT_SECONDARY)
                    .margin({ left: 2 })
                }
                .width('100%')
                .alignItems(VerticalAlign.Center)

                if (this.hasRestSettingsChanges()) {
                  Row() {
                    Blank()
                    Button('ä¿å­˜')
                      .fontSize(Theme.FONT_SIZE_SMALL)
                      .height(36)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(Theme.COLOR_TEXT_PRIMARY)
                      .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
                      .border({ width: 1, color: Theme.COLOR_BORDER })
                      .borderRadius(Theme.BORDER_RADIUS_FULL)
                      .padding({ left: 18, right: 18 })
                      .shadow(Theme.SHADOW_GLOW)
                      .onClick(async () => {
                        await this.saveRestSettings()
                      })
                  }
                  .width('100%')
                  .margin({ top: 8 })
                }
              }
            } else {
              Row() {
                Text('ä¼‘æ¯å·²è¢«ç¦ç”¨')
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_SECONDARY)
              }
              .width('100%')
              .padding({ top: 6, bottom: 6 })
            }
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)

          // å¡ç‰‡3ï¼šå…³äº
          Column({ space: 16 }) {
            Row({ space: 8 }) {
              Text('â„¹ï¸')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
              Text('å…³äº')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Column({ space: 4 }) {
                Text('ç‰ˆæœ¬å·')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }
              .alignItems(HorizontalAlign.Start)
              
              Blank()
              
              Text('1.0.0')
                .fontSize(Theme.FONT_SIZE_MEDIUM)
                .fontWeight(FontWeight.Bold)
                .fontColor(Theme.COLOR_TEXT_PRIMARY)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
                .border({ width: 1, color: Theme.COLOR_BORDER })
                .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
            }
            .width('100%')

            Divider().strokeWidth(1).color(Theme.COLOR_DIVIDER)

            Row() {
              Row({ space: 8 }) {
                Text('ğŸ“–')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                Text('ä½¿ç”¨æŒ‡å—')
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Theme.COLOR_TEXT_PRIMARY)
              }
              Blank()
              Stack({ alignContent: Alignment.Center }) {
                Text('â–¸')
                  .fontSize(Theme.FONT_SIZE_TITLE)
                  .fontColor(Theme.COLOR_TEXT_TERTIARY)
                  .translate({ x: 0, y: -8 })
              }
              .width(24)
              .height(24)
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
            .padding({ top: 4, bottom: 4 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/GuidePage' })
            })
          }
          .width('100%')
          .padding(22)
          .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
          .borderRadius(Theme.BORDER_RADIUS_LARGE)
          .shadow(Theme.SHADOW_MEDIUM)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 80 })
        .opacity(this.contentOpacity)
        .animation({
          duration: Theme.ANIMATION_NORMAL,
          curve: Curve.EaseOut
        })
      }
      .width('100%')
      .layoutWeight(1)

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNav({ currentIndex: 2 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Theme.COLOR_BACKGROUND)
    .gesture(
      PanGesture({ direction: PanDirection.Horizontal })
        .onActionUpdate((event: GestureEvent) => {
          this.panOffsetX = event.offsetX
        })
        .onActionEnd((event: GestureEvent) => {
          this.handleSwipeGesture(event.offsetX, event.velocityX)
          this.panOffsetX = 0
        })
    )
  }

  // ä¿å­˜ä¼‘æ¯é—´éš”è®¾ç½®
  private hasRestSettingsChanges(): boolean {
    return this.restMinutes !== this.initialRestMinutes
      || this.restIntervalHours !== this.initialRestIntervalHours
      || this.restIntervalMinutes !== this.initialRestIntervalMinutes
  }

  private async saveRestSettings() {
    const totalMinutes = this.restIntervalHours * 60 + this.restIntervalMinutes
    await SettingsService.setDefaultRestDuration(this.restMinutes)
    await SettingsService.setDefaultRestInterval(totalMinutes)
    this.initialRestMinutes = this.restMinutes
    this.initialRestIntervalHours = this.restIntervalHours
    this.initialRestIntervalMinutes = this.restIntervalMinutes
    promptAction.showToast({ message: 'è®¾ç½®å·²ä¿å­˜' })
  }

  private handleSwipeGesture(offsetX: number, velocity: number) {
    if (this.isOnboardingActive()) {
      return
    }
    const absOffset = Math.abs(offsetX)
    const absVelocity = Math.abs(velocity)
    
    // å¿«é€Ÿæ»‘åŠ¨æˆ–æ»‘åŠ¨è·ç¦»è¶³å¤Ÿ
    if (absVelocity > 500 || absOffset > this.swipeThreshold) {
      if (offsetX > 0) {
        // å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°é¦–é¡µ
        router.replaceUrl({ url: 'pages/Index' })
      } else if (offsetX < 0) {
        // å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°å†å²é¡µé¢
        router.replaceUrl({ url: 'pages/HistoryPage' })
      }
    }
  }

  private isOnboardingActive(): boolean {
    if (this.onboardingStepId === '') {
      return false
    }
    return shouldShowOnboarding(this.hasSeenOnboarding, this.onboardingDisabled)
  }
}
