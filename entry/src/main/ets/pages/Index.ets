
/**
 * é¦–é¡µ - ä»»åŠ¡åˆ—è¡¨ï¼ˆåŸºäºŽFigma Design + UI çŽ°ä»£åŒ–ï¼‰
 */

import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { TaskStore, TaskState } from '../store/taskStore'
import { FocusStore } from '../store/focusStore'
import { Task } from '../model/Task'
import { FocusSession, SessionType } from '../model/FocusSession'
import { TaskItem } from '../components/TaskItem'
import { BottomNav } from '../components/BottomNav'
import { Theme } from '../common/theme'
import { Logger } from '../common/logger'
import { SettingsService } from '../services/SettingsService'

@Entry
@Component
struct Index {
  @State taskState: TaskState = TaskStore.getState()
  @State showRecoverDialog: boolean = false
  @State recoveredSession: FocusSession | null = null
  @State recoveredTaskTitle: string = ''
  async aboutToAppear() {
    // åˆå§‹åŒ–æœåŠ¡
    TaskStore.init(getContext(this))
    FocusStore.init(getContext(this))
    await SettingsService.init(getContext(this))

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
    await TaskStore.loadTasks()
    this.taskState = TaskStore.getState()

    // æ£€æŸ¥æœªå®Œæˆçš„ä¼šè¯
    const recoverResult = await FocusStore.checkAndRecoverSession()
    if (recoverResult.ok && recoverResult.data !== null && recoverResult.data !== undefined) {
      this.recoveredSession = recoverResult.data
      // æŸ¥æ‰¾ä»»åŠ¡æ ‡é¢˜
      if (this.recoveredSession && this.recoveredSession.taskId) {
        const task = TaskStore.findTask(this.recoveredSession.taskId)
        this.recoveredTaskTitle = task?.title ?? 'åŒ¿åä¸“æ³¨'
      } else {
        this.recoveredTaskTitle = 'åŒ¿åä¸“æ³¨'
      }
      this.showRecoverDialog = true
    }
  }
  // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶åˆ·æ–°ä»»åŠ¡åˆ—ï¿½?
  async onPageShow() {
    await TaskStore.loadTasks()
    this.taskState = TaskStore.getState()
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜åŒºï¼ˆæ¸å˜èƒŒæ™¯ - UI çŽ°ä»£åŒ–ï¼‰
        Row() {
          Text('Focus')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .width('100%')
        .height(80)
        .padding({ left: Theme.SPACE_LARGE, top: Theme.SPACE_XLARGE, bottom: Theme.SPACE_LARGE })
        .linearGradient({
          angle: 135,
          colors: [
            [Theme.COLOR_PRIMARY_LIGHT, 0],
            [Theme.COLOR_PRIMARY, 1]
          ]
        })
        .shadow({
          radius: Theme.SHADOW_MEDIUM.radius,
          color: Theme.SHADOW_MEDIUM.color,
          offsetX: 0,
          offsetY: 4
        })
        // ä»»åŠ¡åˆ—è¡¨æˆ–ç©ºçŠ¶æ€
        if (this.taskState.loading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(Theme.FONT_SIZE_MEDIUM)
              .fontColor(Theme.COLOR_TEXT_SECONDARY)
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.taskState.tasks.length === 0) {
          // ç©ºçŠ¶æ€
          Column({ space: Theme.SPACE_LARGE }) {
            Text('ðŸ“')
              .fontSize(64)
            Text('è¿˜æ²¡æœ‰ä»»åŠ¡?')
              .fontSize(Theme.FONT_SIZE_LARGE)
              .fontColor(Theme.COLOR_TEXT_PRIMARY)
              .fontWeight(FontWeight.Medium)
            
            Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œ\næˆ–ç›´æŽ¥å¼€å§‹å¿«é€Ÿä¸“æ³¨')
              .fontSize(Theme.FONT_SIZE_MEDIUM)
              .fontColor(Theme.COLOR_TEXT_TERTIARY)
              .textAlign(TextAlign.Center)

            Button('å¼€å§‹å¿«é€Ÿä¸“æ³¨')
              .fontSize(Theme.FONT_SIZE_MEDIUM)
              .height(48)
              .backgroundColor(Theme.COLOR_PRIMARY)
              .borderRadius(Theme.BORDER_RADIUS_LARGE)
              .onClick(() => {
                this.startFocusWithoutTask()
              })
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .padding(Theme.SPACE_LARGE)
        } else {
          // ä»»åŠ¡åˆ—è¡¨
          List({ space: Theme.SPACE_MEDIUM }) {
            ForEach(this.taskState.tasks, (task: Task) => {
              ListItem() {
                TaskItem({
                  task: task,
                  onStart: (t: Task) => {
                    this.startFocusWithTask(t)
                  },
                  onDelete: (t: Task) => {
                    this.deleteTask(t)
                  }
                })
              }
            }, (task: Task) => task.id.toString())
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ 
            left: Theme.SPACE_MEDIUM, 
            right: Theme.SPACE_MEDIUM, 
            top: Theme.SPACE_MEDIUM,
            bottom: Theme.SPACE_MEDIUM 
          })
        }
        // åº•éƒ¨å¯¼èˆªæ 
        BottomNav({ currentIndex: 0 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(Theme.COLOR_BACKGROUND)

      // æµ®åŠ¨æŒ‰é’®åŒº
      Column({ space: Theme.SPACE_SMALL }) {
        // å¿«é€Ÿä¸“æ³¨æŒ‰é’®
        Button({ type: ButtonType.Circle }) {
          Text('+')  
            .fontSize(22)
            .fontColor(Color.White)
        }
        .width(48)
        .height(48)
        .backgroundColor(Theme.COLOR_SUCCESS)
        .shadow({
          radius: Theme.SHADOW_MEDIUM.radius,
          color: Theme.SHADOW_MEDIUM.color,
          offsetX: Theme.SHADOW_MEDIUM.offsetX,
          offsetY: Theme.SHADOW_MEDIUM.offsetY
        })
        .onClick(() => {
          this.startFocusWithoutTask()
        })

        // æ·»åŠ ä»»åŠ¡æŒ‰é’®ï¼ˆæ¸å˜è‰²ï¼‰
        Button({ type: ButtonType.Circle }) {
          Text('+')
            .fontSize(36)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .width(64)
        .height(64)
        .linearGradient({
          angle: 135,
          colors: [
            [Theme.COLOR_PRIMARY_LIGHT, 0],
            [Theme.COLOR_PRIMARY, 1]
          ]
        })
        .shadow({
          radius: Theme.SHADOW_LARGE.radius,
          color: Theme.SHADOW_LARGE.color,
          offsetX: Theme.SHADOW_LARGE.offsetX,
          offsetY: Theme.SHADOW_LARGE.offsetY
        })
        .onClick(() => {
          router.pushUrl({ url: 'pages/TaskEditPage' })
        })
      }
      .margin({ right: Theme.SPACE_LARGE, bottom: 90 })
      // ä¼šè¯æ¢å¤å¯¹è¯æ¡†
      if (this.showRecoverDialog) {
        this.RecoverDialog()
      }
    }
    .width('100%')
    .height('100%')
  }
  // ä¼šè¯æ¢å¤å¯¹è¯æ¡†ç»„ä»¶
  @Builder
  RecoverDialog() {
    Column() {
      // åŠé€æ˜Žé®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000060')
        .onClick(() => {
          // ç‚¹å‡»é®ç½©ä¸å…³é—­ï¼Œå¿…é¡»é€‰æ‹©
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: Theme.SPACE_LARGE }) {
        Text('å‘çŽ°æœªå®Œæˆçš„ä¸“æ³¨')
          .fontSize(Theme.FONT_SIZE_LARGE)
          .fontWeight(FontWeight.Bold)
          .fontColor(Theme.COLOR_TEXT_PRIMARY)

        Column({ space: Theme.SPACE_SMALL }) {
          Text(`ä»»åŠ¡ï¼š${this.recoveredTaskTitle}`)
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .fontColor(Theme.COLOR_TEXT_PRIMARY)

          if (this.recoveredSession) {
            Text(`å·²ä¸“æ³¨ï¼š${this.formatDuration(this.recoveredSession.actualFocusDuration)}`)
              .fontSize(Theme.FONT_SIZE_SMALL)
              .fontColor(Theme.COLOR_TEXT_SECONDARY)
          }

          Text('ä¸Šæ¬¡ä¼šè¯å·²æš‚åœï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')
            .fontSize(Theme.FONT_SIZE_SMALL)
            .fontColor(Theme.COLOR_TEXT_TERTIARY)
            .margin({ top: Theme.SPACE_SMALL })
        }

        Row({ space: Theme.SPACE_MEDIUM }) {
          Button('æ”¾å¼ƒ')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .height(48)
            .layoutWeight(1)
            .backgroundColor(Theme.COLOR_TEXT_TERTIARY)
            .borderRadius(Theme.BORDER_RADIUS_LARGE)
            .onClick(async () => {
              // æ”¾å¼ƒä¼šè¯ - å°†å…¶æ ‡è®°ä¸ºå®Œæˆ
              if (this.recoveredSession) {
                await FocusStore.finishFocus()
              }
              this.showRecoverDialog = false
              this.recoveredSession = null
            })

          Button('ç»§ç»­ä¸“æ³¨')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .height(48)
            .layoutWeight(1)
            .backgroundColor(Theme.COLOR_PRIMARY)
            .borderRadius(Theme.BORDER_RADIUS_LARGE)
            .onClick(async () => {
              this.showRecoverDialog = false
              // æ¢å¤ä¼šè¯å¹¶è·³è½¬
              if (this.recoveredSession) {
                await FocusStore.recoverSession(this.recoveredSession)
                router.pushUrl({ url: 'pages/FocusPage' })
              }
            })
        }
        .width('100%')
      }
      .width('85%')
      .padding(Theme.SPACE_XLARGE)
      .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
      .borderRadius(Theme.BORDER_RADIUS_LARGE)
      .shadow({
        radius: Theme.SHADOW_LARGE.radius,
        color: Theme.SHADOW_LARGE.color,
        offsetX: 0,
        offsetY: 8
      })
      .position({ x: '7.5%', y: '35%' })
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatDuration(ms: number): string {
    const seconds = Math.floor(ms / 1000)
    const minutes = Math.floor(seconds / 60)
    const hours = Math.floor(minutes / 60)
    
    if (hours > 0) {
      return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`
    } else if (minutes > 0) {
      return `${minutes}åˆ†é’Ÿ`
    } else {
      return `${seconds}ç§’`
    }
  }

  // æ— ä»»åŠ¡å¼€å§‹ä¸“æ³¨
  private async startFocusWithoutTask() {
    router.pushUrl({ url: 'pages/StartPage' })
  }

  // æœ‰ä»»åŠ¡å¼€å§‹ä¸“æ³¨
  private async startFocusWithTask(task: Task) {
    router.pushUrl({ 
      url: 'pages/StartPage',
      params: { taskId: task.id, taskTitle: task.title }
    })
  }

  // åˆ é™¤ä»»åŠ¡
  private async deleteTask(task: Task) {
    const result = await TaskStore.deleteTask(task.id)
    if (result.ok) {
      promptAction.showToast({ message: 'ä»»åŠ¡å·²åˆ é™¤' })
    } else {
      promptAction.showToast({ message: result.message ?? 'Unknown error' })
    }
  }
}
