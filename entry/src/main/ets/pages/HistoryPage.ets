/**
 * å†å²é¡µ - å·²å®Œæˆä»»åŠ¡å’Œä¸“æ³¨è®°å½•ï¼ˆUI ç°ä»£åŒ–ç‰ˆæœ¬ï¼‰
 */

import router from '@ohos.router'
import { TaskRepo } from '../data/TaskRepo'
import { SessionRepo, SessionStats } from '../data/SessionRepo'
import { Task } from '../model/Task'
import { FocusSession } from '../model/FocusSession'
import { BottomNav } from '../components/BottomNav'
import { StatCard } from '../components/StatCard'
import { Theme } from '../common/theme'

@Entry
@Component
struct HistoryPage {
  @State completedTasks: Task[] = []
  @State recentSessions: FocusSession[] = []
  @State stats: SessionStats = {
    totalFocusTime: 0,
    sessionCount: 0,
    totalBreaks: 0,
    todayFocusTime: 0
  }
  @State loading: boolean = false
  @State activeTab: number = 0 // 0: ä»»åŠ¡, 1: ä¼šè¯

  async aboutToAppear() {
    await this.loadData()
  }

  // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
  onPageShow() {
    this.loadData()
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºï¼ˆæ¸å˜èƒŒæ™¯ï¼‰
      Column() {
        Row() {
          Text('å†å²è®°å½•')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .width('100%')
        .padding({ left: Theme.SPACE_LARGE, top: Theme.SPACE_XLARGE, bottom: Theme.SPACE_MEDIUM })

        // ç»Ÿè®¡å¡ç‰‡ï¼ˆä»Šæ—¥ä¸“æ³¨ï¼‰
        Column() {
          Text('ä»Šæ—¥ä¸“æ³¨')
            .fontSize(Theme.FONT_SIZE_SMALL)
            .fontColor('#ffffffcc')
          
          Text(this.formatDurationLong(this.stats.todayFocusTime))
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ top: Theme.SPACE_SMALL })
        }
        .width('100%')
        .padding({ left: Theme.SPACE_LARGE, bottom: Theme.SPACE_LARGE })
      }
      .width('100%')
      .linearGradient({
        angle: 135,
        colors: [
          [Theme.COLOR_PRIMARY_LIGHT, 0],
          [Theme.COLOR_PRIMARY, 1]
        ]
      })

      // ç»Ÿè®¡å¡ç‰‡è¡Œ
      Row({ space: Theme.SPACE_SMALL }) {
        Column() {
          Text(this.formatDurationShort(this.stats.totalFocusTime))
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_PRIMARY)
          Text('æ€»ä¸“æ³¨')
            .fontSize(Theme.FONT_SIZE_TINY)
            .fontColor(Theme.COLOR_TEXT_TERTIARY)
        }
        .layoutWeight(1)
        .padding(Theme.SPACE_MEDIUM)
        .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
        .borderRadius(Theme.BORDER_RADIUS_MEDIUM)

        Column() {
          Text(this.stats.sessionCount.toString())
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_SUCCESS)
          Text('ä¼šè¯æ•°')
            .fontSize(Theme.FONT_SIZE_TINY)
            .fontColor(Theme.COLOR_TEXT_TERTIARY)
        }
        .layoutWeight(1)
        .padding(Theme.SPACE_MEDIUM)
        .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
        .borderRadius(Theme.BORDER_RADIUS_MEDIUM)

        Column() {
          Text(this.stats.totalBreaks.toString())
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_WARNING)
          Text('ä¼‘æ¯æ¬¡æ•°')
            .fontSize(Theme.FONT_SIZE_TINY)
            .fontColor(Theme.COLOR_TEXT_TERTIARY)
        }
        .layoutWeight(1)
        .padding(Theme.SPACE_MEDIUM)
        .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
        .borderRadius(Theme.BORDER_RADIUS_MEDIUM)

        Column() {
          Text(this.completedTasks.length.toString())
            .fontSize(Theme.FONT_SIZE_LARGE)
            .fontWeight(FontWeight.Bold)
            .fontColor(Theme.COLOR_ERROR)
          Text('å·²å®Œæˆ')
            .fontSize(Theme.FONT_SIZE_TINY)
            .fontColor(Theme.COLOR_TEXT_TERTIARY)
        }
        .layoutWeight(1)
        .padding(Theme.SPACE_MEDIUM)
        .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
        .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
      }
      .width('100%')
      .padding({ left: Theme.SPACE_MEDIUM, right: Theme.SPACE_MEDIUM, top: Theme.SPACE_MEDIUM })

      // Tab åˆ‡æ¢
      Row() {
        Button('å·²å®Œæˆä»»åŠ¡')
          .fontSize(Theme.FONT_SIZE_SMALL)
          .height(36)
          .backgroundColor(this.activeTab === 0 ? Theme.COLOR_PRIMARY : Theme.COLOR_BACKGROUND)
          .fontColor(this.activeTab === 0 ? Color.White : Theme.COLOR_TEXT_SECONDARY)
          .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
          .layoutWeight(1)
          .onClick(() => {
            this.activeTab = 0
          })

        Button('ä¸“æ³¨è®°å½•')
          .fontSize(Theme.FONT_SIZE_SMALL)
          .height(36)
          .backgroundColor(this.activeTab === 1 ? Theme.COLOR_PRIMARY : Theme.COLOR_BACKGROUND)
          .fontColor(this.activeTab === 1 ? Color.White : Theme.COLOR_TEXT_SECONDARY)
          .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
          .layoutWeight(1)
          .onClick(() => {
            this.activeTab = 1
          })
      }
      .width('100%')
      .padding({ left: Theme.SPACE_LARGE, right: Theme.SPACE_LARGE, top: Theme.SPACE_MEDIUM })

      // å†…å®¹åŒº
      if (this.loading) {
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(Theme.FONT_SIZE_MEDIUM)
            .fontColor(Theme.COLOR_TEXT_SECONDARY)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.activeTab === 0) {
        // å·²å®Œæˆä»»åŠ¡åˆ—è¡¨
        this.TaskListContent()
      } else {
        // ä¸“æ³¨è®°å½•åˆ—è¡¨
        this.SessionListContent()
      }

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNav({ currentIndex: 1 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Theme.COLOR_BACKGROUND)
  }

  @Builder
  TaskListContent() {
    if (this.completedTasks.length === 0) {
      Column({ space: Theme.SPACE_MEDIUM }) {
        Text('ğŸ“')
          .fontSize(48)
        Text('è¿˜æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡')
          .fontSize(Theme.FONT_SIZE_MEDIUM)
          .fontColor(Theme.COLOR_TEXT_TERTIARY)
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      List({ space: Theme.SPACE_MEDIUM }) {
        ForEach(this.completedTasks, (task: Task) => {
          ListItem() {
            Column() {
              Row() {
                Column({ space: Theme.SPACE_TINY }) {
                  Text(task.title)
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(Theme.COLOR_TEXT_PRIMARY)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  if (task.completedAt) {
                    Text('å®Œæˆäº ' + this.formatDate(task.completedAt))
                      .fontSize(Theme.FONT_SIZE_TINY)
                      .fontColor(Theme.COLOR_TEXT_TERTIARY)
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Column() {
                  Text(this.formatDurationShort(task.totalFocusTime))
                    .fontSize(Theme.FONT_SIZE_MEDIUM)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Theme.COLOR_PRIMARY)
                }
              }
              .width('100%')
            }
            .width('100%')
            .padding(Theme.SPACE_MEDIUM)
            .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
            .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
            .shadow({
              radius: Theme.SHADOW_SMALL.radius,
              color: Theme.SHADOW_SMALL.color,
              offsetX: 0,
              offsetY: 2
            })
          }
        }, (task: Task) => task.id.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .padding({
        left: Theme.SPACE_LARGE,
        right: Theme.SPACE_LARGE,
        top: Theme.SPACE_MEDIUM
      })
    }
  }

  @Builder
  SessionListContent() {
    if (this.recentSessions.length === 0) {
      Column({ space: Theme.SPACE_MEDIUM }) {
        Text('â±')
          .fontSize(48)
        Text('è¿˜æ²¡æœ‰ä¸“æ³¨è®°å½•')
          .fontSize(Theme.FONT_SIZE_MEDIUM)
          .fontColor(Theme.COLOR_TEXT_TERTIARY)
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      List({ space: Theme.SPACE_MEDIUM }) {
        ForEach(this.recentSessions, (session: FocusSession) => {
          ListItem() {
            Column({ space: Theme.SPACE_SMALL }) {
              Row() {
                Text(this.formatDate(session.startAt))
                  .fontSize(Theme.FONT_SIZE_SMALL)
                  .fontColor(Theme.COLOR_TEXT_SECONDARY)

                Blank()

                Text(this.formatDurationShort(session.actualFocusDuration))
                  .fontSize(Theme.FONT_SIZE_MEDIUM)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Theme.COLOR_PRIMARY)
              }
              .width('100%')

              Row({ space: Theme.SPACE_SMALL }) {
                // ä¼šè¯ç±»å‹æ ‡ç­¾
                Text(this.getSessionTypeLabel(session.sessionType))
                  .fontSize(Theme.FONT_SIZE_TINY)
                  .fontColor(Color.White)
                  .padding({ left: Theme.SPACE_SMALL, right: Theme.SPACE_SMALL, top: 2, bottom: 2 })
                  .backgroundColor(Theme.COLOR_PRIMARY)
                  .borderRadius(Theme.BORDER_RADIUS_SMALL)

                // ä¼‘æ¯æ¬¡æ•°
                if (session.breakCount > 0) {
                  Text('ä¼‘æ¯ ' + session.breakCount + ' æ¬¡')
                    .fontSize(Theme.FONT_SIZE_TINY)
                    .fontColor(Theme.COLOR_TEXT_TERTIARY)
                }
              }

              // ä¸­æ–­åŸå› 
              if (session.interruptionReason && session.interruptionReason !== '') {
                Text('ä¸­æ–­åŸå› : ' + session.interruptionReason)
                  .fontSize(Theme.FONT_SIZE_TINY)
                  .fontColor(Theme.COLOR_WARNING)
              }
            }
            .width('100%')
            .padding(Theme.SPACE_MEDIUM)
            .backgroundColor(Theme.COLOR_CARD_BACKGROUND)
            .borderRadius(Theme.BORDER_RADIUS_MEDIUM)
            .shadow({
              radius: Theme.SHADOW_SMALL.radius,
              color: Theme.SHADOW_SMALL.color,
              offsetX: 0,
              offsetY: 2
            })
          }
        }, (session: FocusSession) => session.id.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .padding({
        left: Theme.SPACE_LARGE,
        right: Theme.SPACE_LARGE,
        top: Theme.SPACE_MEDIUM
      })
    }
  }

  private async loadData() {
    this.loading = true
    // å¹¶è¡ŒåŠ è½½æ•°æ®
    const results = await Promise.all([
      TaskRepo.findCompleted(getContext(this)),
      SessionRepo.findCompleted(getContext(this), 50),
      SessionRepo.getStats(getContext(this))
    ])
    const tasksResult = results[0]
    const sessionsResult = results[1]
    const statsResult = results[2]

    if (tasksResult.ok && tasksResult.data) {
      this.completedTasks = tasksResult.data
    }

    if (sessionsResult.ok && sessionsResult.data) {
      this.recentSessions = sessionsResult.data
    }

    if (statsResult.ok && statsResult.data) {
      this.stats = statsResult.data
    }

    this.loading = false
  }

  private formatDurationLong(ms: number): string {
    const seconds = Math.floor(ms / 1000)
    const minutes = Math.floor(seconds / 60)
    const hours = Math.floor(minutes / 60)
    
    if (hours > 0) {
      return hours + 'å°æ—¶' + (minutes % 60) + 'åˆ†é’Ÿ'
    } else if (minutes > 0) {
      return minutes + 'åˆ†é’Ÿ'
    } else {
      return seconds + 'ç§’'
    }
  }

  private formatDurationShort(ms: number): string {
    const minutes = Math.floor(ms / (1000 * 60))
    const hours = Math.floor(minutes / 60)

    if (hours > 0) {
      return hours + 'h ' + (minutes % 60) + 'm'
    } else {
      return minutes + 'm'
    }
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp)
    const month = date.getMonth() + 1
    const day = date.getDate()
    const hour = date.getHours()
    const minute = date.getMinutes()

    return month + 'æœˆ' + day + 'æ—¥ ' + this.pad(hour) + ':' + this.pad(minute)
  }

  private pad(num: number): string {
    return num < 10 ? '0' + num : num.toString()
  }

  private getSessionTypeLabel(type: string): string {
    switch (type) {
      case 'COUNTDOWN':
        return 'å€’è®¡æ—¶'
      case 'POMODORO':
        return 'ç•ªèŒ„é’Ÿ'
      default:
        return 'æ­£è®¡æ—¶'
    }
  }
}
